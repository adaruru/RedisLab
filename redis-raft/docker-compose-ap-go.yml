services:
  redis-raft-apgo:
    build:
      context: ../
      dockerfile: APGo/Dockerfile
    container_name: redis-raft-apgo
    environment:
    - GO_ENV=raft
    - TZ=Asia/Taipei
    ports:
    - "8080:8080"
    depends_on:
    - redis-raft1
    - redis-raft2
    - redis-raft3
    networks:
    - redis-network

  redis-raft1:
    build:
      context: .
      dockerfile: Dockerfile.redisraft
    container_name: redis-raft1
    command: >
      redis-server --bind 0.0.0.0 --port 6379 --loadmodule /usr/lib/redis/modules/redisraft.so raft-log-filename raftlog1.db id 1 addr redis-raft1:6379
    volumes:
    - ./data/raft1:/data
    ports:
    - "6379:6379"
    networks:
    - redis-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 10

  redis-raft2:
    build:
      context: .
      dockerfile: Dockerfile.redisraft
    container_name: redis-raft2
    command: >
      redis-server --bind 0.0.0.0 --port 6379 --loadmodule /usr/lib/redis/modules/redisraft.so raft-log-filename raftlog2.db id 2 addr redis-raft2:6379
    volumes:
    - ./data/raft2:/data
    ports:
    - "6380:6379"
    networks:
    - redis-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 10

  redis-raft3:
    build:
      context: .
      dockerfile: Dockerfile.redisraft
    container_name: redis-raft3
    command: >
      redis-server --bind 0.0.0.0 --port 6379 --loadmodule /usr/lib/redis/modules/redisraft.so raft-log-filename raftlog3.db id 3 addr redis-raft3:6379
    volumes:
    - ./data/raft3:/data
    ports:
    - "6381:6379"
    networks:
    - redis-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 10

  raft-cluster-init:
    build:
      context: .
      dockerfile: Dockerfile.redisraft
    container_name: raft-cluster-init
    entrypoint:
    - /bin/sh
    - -c
    - |
      echo "Waiting for Redis nodes to be ready..."
      sleep 10

      echo "Initializing Raft cluster..."

      # 初始化第一個節點作為 Raft 集群
      redis-cli -h redis-raft1 RAFT.CLUSTER INIT

      # 等待初始化完成
      sleep 3

      # 將其他節點加入集群
      echo "Joining node 2..."
      redis-cli -h redis-raft2 RAFT.CLUSTER JOIN redis-raft1:6379

      echo "Joining node 3..."
      redis-cli -h redis-raft3 RAFT.CLUSTER JOIN redis-raft1:6379

      echo "Raft cluster initialized successfully!"

      # 顯示集群狀態
      echo "Cluster status:"
      redis-cli -h redis-raft1 RAFT.INFO
    depends_on:
      redis-raft1:
        condition: service_healthy
      redis-raft2:
        condition: service_healthy
      redis-raft3:
        condition: service_healthy
    networks:
    - redis-network

networks:
  redis-network:
    driver: bridge
